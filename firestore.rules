rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Portfolios: doc ID = userId. Users publish their own profile.
    match /portfolios/{userId} {
      // Anyone can read published portfolios (Explore, Discover, public profile).
      // Owner can read their own doc (including when unpublished, for isPublished check).
      allow read: if resource != null && (
        resource.data.published == true
        || (request.auth != null && request.auth.uid == userId)
      );

      // Only the owner can create or update their portfolio.
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // Owner can delete their own portfolio (e.g. account deletion).
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Hire requests: sent by hirers, received by portfolio owners. Contact info only.
    match /hireRequests/{requestId} {
      // Recipient can read their hire requests.
      allow read: if request.auth != null
        && resource.data.toUserId == request.auth.uid;

      // Authenticated users can create hire requests. Enforce fromUserId matches.
      allow create: if request.auth != null
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.toUserId is string
        && request.resource.data.toUserId != '';

      allow update, delete: if false;
    }

    // Users: account type and company info. Doc ID = uid.
    match /users/{userId} {
      // Users can only read and write their own document.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
